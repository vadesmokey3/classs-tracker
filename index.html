<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- THESE LINES FORCE "APP MODE" ON iPHONE -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Class Tracker">
  
  <title>Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
  
  <!-- PWA MANIFEST (REQUIRED) -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"Class Tracker","short_name":"Tracker","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#4F46E5","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3389/3389081.png","sizes":"192x192","type":"image/png"}]}' />

  <style>
    body { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 pb-20">

  <!-- STATUS INDICATOR -->
  <div id="status-bar" class="bg-red-600 text-white p-2 text-center text-xs font-bold">
    MODE: BROWSER TAB (NOTIFICATIONS BLOCKED ‚ùå)
  </div>

  <div class="bg-indigo-900 p-4 sticky top-0 z-50 shadow-xl text-center">
    <button onclick="tryNotify()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-xl text-lg shadow-lg">
      üîî ENABLE & TEST
    </button>
  </div>

  <div id="app" class="pt-4"></div>
  <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

  <script>
    // --- 1. DETECT MODE VISUALLY ---
    const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
    const bar = document.getElementById('status-bar');
    
    if (isStandalone) {
      bar.innerHTML = "MODE: APP INSTALLED (READY ‚úÖ)";
      bar.className = "bg-green-600 text-white p-2 text-center text-xs font-bold";
    }

    // --- 2. NOTIFICATION LOGIC ---
    async function tryNotify() {
      // Step 1: Request
      try {
        const p = await Notification.requestPermission();
        if (p === 'granted') {
          alert("‚úÖ Permission Granted! Wait 5s...");
          
          // Step 2: Timer
          setTimeout(() => {
            trigger("Test Notification", "It works!");
          }, 5000);
        } else {
          alert("‚ùå Permission Denied. Check Settings.");
        }
      } catch (e) {
        alert("‚ö†Ô∏è Error: " + e.message + "\n(This usually means you are not in App Mode)");
      }
    }

    function trigger(title, body) {
      document.getElementById('notif-sound').play().catch(()=>{});
      if(navigator.vibrate) navigator.vibrate([500]);
      
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'SHOW_NOTIFICATION', title, body });
      } else {
        new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png' });
      }
    }

    // --- SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
      const swCode = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('message',e=>{if(e.data.type==='SHOW_NOTIFICATION')self.registration.showNotification(e.data.title,{body:e.data.body,icon:'https://cdn-icons-png.flaticon.com/512/3389/3389081.png'})});`;
      const blob = new Blob([swCode], {type: 'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    }

    // --- APP ---
    const SCHEDULE={1:['Math','Economy'],2:['Math','Essay','CS'],3:['Math'],4:['Economy'],5:['Essay','Math','CS']};
    const CLASSES=['Math','Economy','CS','Essay'];
    let counts={Math:0,Economy:0,CS:0,Essay:0}, todayAttended={}, editMode=null, editValue='';

    function loadData() {
      const s=localStorage.getItem('class-counts-v2'); if(s)counts=JSON.parse(s);
      const t=new Date().toDateString();
      if(localStorage.getItem('last-date')!==t) { todayAttended={}; localStorage.setItem('today-attended-v2',JSON.stringify({})); localStorage.setItem('last-date',t); }
      else { const st=localStorage.getItem('today-attended-v2'); if(st)todayAttended=JSON.parse(st); }
    }
    function saveData() { localStorage.setItem('class-counts-v2',JSON.stringify(counts)); localStorage.setItem('today-attended-v2',JSON.stringify(todayAttended)); }
    
    function markAttendance(c,a) {
      const p=todayAttended[c]; todayAttended[c]=a;
      if(a){ if(p!==true)counts[c]++; if(counts[c]===9)trigger('ŒïŒôŒîŒüŒ†ŒüŒôŒóŒ£Œó',`œÄŒªŒ∑œÅœâœÉŒµ ${c}`); if(counts[c]>=10)counts[c]=0; }
      else{ if(p===true&&counts[c]>0)counts[c]--; }
      saveData(); render();
    }
    
    function render() {
      const d=new Date().getDay(), tc=SCHEDULE[d]||[];
      document.getElementById('app').innerHTML=`
        <div class="max-w-md mx-auto px-4">
           <div class="bg-white p-4 rounded-xl shadow mb-4">
             <h2 class="font-bold mb-2">Today</h2>
             ${tc.map(c=>`<div class="flex justify-between mb-2 p-2 bg-slate-50 rounded"><span>${c}</span><div><button onclick="markAttendance('${c}',false)" class="px-2 border bg-white">Miss</button><button onclick="markAttendance('${c}',true)" class="px-2 border bg-white ml-2">Attend</button></div></div>`).join('')}
           </div>
           <div class="grid grid-cols-2 gap-2">
             ${CLASSES.map(c=>`<div class="bg-white p-3 rounded shadow text-center"><div class="font-bold">${c}</div><div class="text-2xl">${counts[c]}/10</div></div>`).join('')}
           </div>
        </div>`;
    }
    loadData(); render();
  </script>
</body>
</html>
