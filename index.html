<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Basic Manifest -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"Class Tracker","short_name":"Tracker","display":"standalone","background_color":"#ffffff","theme_color":"#4F46E5","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3389/3389081.png","sizes":"192x192","type":"image/png"}]}' />
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 pb-20">

  <!-- üö® STATIC TEST BUTTON -->
  <div class="bg-indigo-900 p-4 sticky top-0 z-50 shadow-xl">
    <button onclick="start30sTest()" id="test-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl text-lg animate-pulse border-2 border-white shadow-lg">
      üîî TEST NOTIFICATION (30s)
    </button>
    <p class="text-indigo-200 text-xs text-center mt-2">1. Press Button  2. Press Home  3. Wait 30s</p>
  </div>

  <div id="app"></div>
  
  <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

  <script>
    // --- ROBUST SERVICE WORKER (Force High Priority) ---
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', (e) => self.skipWaiting());
        self.addEventListener('activate', (e) => self.clients.claim());
        
        self.addEventListener('message', (e) => {
          if (e.data && e.data.type === 'SHOW_NOTIFICATION') {
            // FORCE VISUAL NOTIFICATION
            self.registration.showNotification(e.data.title, {
              body: e.data.body,
              icon: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png',
              vibrate: [200, 100, 200, 100, 200], // Long vibration
              tag: 'alert-' + Date.now(), // Unique tag forces new popup
              renotify: true, // Forces phone to buzz again
              requireInteraction: true, // Keeps it on screen
              data: { url: self.location.origin } 
            });
          }
        });

        self.addEventListener('notificationclick', function(event) {
          event.notification.close();
          event.waitUntil(clients.openWindow('.'));
        });
      `;
      const blob = new Blob([swCode], {type: 'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob))
        .then(() => console.log("Service Worker Ready"));
    }

    // --- NOTIFICATION TRIGGER ---
    function triggerPushNotification(title, body) {
      // 1. Audio (Always runs)
      document.getElementById('notif-sound').play().catch(()=>{});
      
      // 2. Vibrate (Always runs)
      if (navigator.vibrate) navigator.vibrate([500, 200, 500]);

      // 3. Visual Notification
      if (Notification.permission === 'granted') {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          // Send to Service Worker (Best for background)
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            title: title,
            body: body
          });
        } else {
          // Fallback
          new Notification(title, {
            body: body,
            icon: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png',
            vibrate: [500, 200, 500],
            requireInteraction: true
          });
        }
      }
    }

    function start30sTest() {
      Notification.requestPermission().then(permission => {
        if (permission !== 'granted') {
          alert("PLEASE ENABLE NOTIFICATIONS IN BROWSER SETTINGS");
          return;
        }

        let timeLeft = 30;
        const btn = document.getElementById('test-btn');
        btn.classList.remove('bg-red-600', 'animate-pulse');
        btn.classList.add('bg-yellow-500');
        
        // Removed the alert() so it doesn't block the background process
        
        const interval = setInterval(() => {
          timeLeft--;
          btn.innerText = `‚è≥ EXIT APP NOW (${timeLeft}s)`;
          
          if (timeLeft <= 0) {
            clearInterval(interval);
            btn.innerText = "üîî CHECK NOTIFICATIONS!";
            btn.classList.add('bg-green-500');
            triggerPushNotification("IT WORKS! üöÄ", "This is the visual notification!");
          }
        }, 1000);
      });
    }

    // --- APP LOGIC (Standard) ---
    const SCHEDULE = {
      1: ['Math', 'Economy'],
      2: ['Math', 'Essay', 'CS'],
      3: ['Math'],
      4: ['Economy'],
      5: ['Essay', 'Math', 'CS']
    };
    const CLASSES = ['Math', 'Economy', 'CS', 'Essay'];
    let counts = { Math: 0, Economy: 0, CS: 0, Essay: 0 };
    let todayAttended = {};
    let editMode = null;
    let editValue = '';

    function loadData() {
      const saved = localStorage.getItem('class-counts-v2');
      if (saved) counts = JSON.parse(saved);
      const today = new Date().toDateString();
      if (localStorage.getItem('last-date') !== today) {
        todayAttended = {};
        localStorage.setItem('today-attended-v2', JSON.stringify({}));
        localStorage.setItem('last-date', today);
      } else {
        const savedToday = localStorage.getItem('today-attended-v2');
        if (savedToday) todayAttended = JSON.parse(savedToday);
      }
    }

    function saveData() {
      localStorage.setItem('class-counts-v2', JSON.stringify(counts));
      localStorage.setItem('today-attended-v2', JSON.stringify(todayAttended));
    }

    function markAttendance(className, isAttending) {
      const prev = todayAttended[className];
      todayAttended[className] = isAttending;
      if (isAttending && prev !== true) {
        counts[className]++;
        if (counts[className] >= 10) {
          triggerPushNotification('Goal Reached! üèÜ', `${className} hit 10 attendances!`);
          counts[className] = 0;
        }
      } else if (!isAttending && prev === true && counts[className] > 0) {
        counts[className]--;
      }
      saveData();
      render();
    }

    function startEdit(className) {
      editMode = className;
      editValue = counts[className];
      render();
    }

    function saveEdit() {
      counts[editMode] = parseInt(editValue) || 0;
      if (counts[editMode] >= 10) counts[editMode] = 0;
      editMode = null;
      saveData();
      render();
    }

    function render() {
      const dayOfWeek = new Date().getDay();
      const todayClasses = SCHEDULE[dayOfWeek] || [];
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-md mx-auto mt-4 px-4">
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6">
            <h2 class="font-bold text-slate-700 mb-3">Today's Classes</h2>
            ${todayClasses.length ? todayClasses.map(cls => `
              <div class="flex items-center justify-between mb-3 p-2 bg-slate-50 rounded-lg">
                <span class="font-medium">${cls}</span>
                <div class="flex gap-2">
                  <button onclick="markAttendance('${cls}', false)" class="${todayAttended[cls]===false ? 'bg-red-500 text-white' : 'bg-white border'} px-3 py-1 rounded text-sm">Missed</button>
                  <button onclick="markAttendance('${cls}', true)" class="${todayAttended[cls]===true ? 'bg-green-500 text-white' : 'bg-white border'} px-3 py-1 rounded text-sm">Attended</button>
                </div>
              </div>
            `).join('') : '<p class="text-center text-slate-400">No classes</p>'}
          </div>

          <div class="grid grid-cols-2 gap-3">
            ${CLASSES.map(cls => `
              <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                <div class="flex justify-between mb-1">
                  <span class="text-sm text-slate-500">${cls}</span>
                  <button onclick="startEdit('${cls}')">‚úé</button>
                </div>
                ${editMode === cls ? `
                  <div class="flex gap-1">
                    <input type="number" value="${editValue}" oninput="editValue=this.value" class="w-full border rounded px-1">
                    <button onclick="saveEdit()" class="bg-indigo-500 text-white px-2 rounded">‚úì</button>
                  </div>
                ` : `
                  <div class="text-3xl font-bold">${counts[cls]}<span class="text-sm font-normal text-slate-400">/10</span></div>
                `}
                <div class="absolute bottom-0 left-0 h-1 bg-indigo-500 transition-all duration-500" style="width:${(counts[cls]/10)*100}%"></div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Expose functions
    window.start30sTest = start30sTest;
    window.markAttendance = markAttendance;
    window.startEdit = startEdit;
    window.saveEdit = saveEdit;

    loadData();
    render();
  </script>
</body>
</html>
