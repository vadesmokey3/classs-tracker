<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- iOS SETTINGS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tracker">
  
  <title>Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- LINK TO THE NEW MANIFEST FILE -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">

  <style>
    body { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 pb-20">

  <!-- STATUS BAR -->
  <div id="status-bar" class="bg-red-600 text-white p-3 text-center text-xs font-bold uppercase tracking-wider">
    Not Installed (Notifications Blocked)
  </div>

  <div class="bg-indigo-900 p-4 sticky top-0 z-50 shadow-xl text-center">
    <button onclick="tryNotify()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-xl text-lg shadow-lg active:scale-95 transition-transform">
      ðŸ”” ENABLE & TEST
    </button>
  </div>

  <div id="app" class="pt-4"></div>
  <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

  <script>
    // --- 1. DETECT APP MODE ---
    // If this turns GREEN on your phone, you fixed it.
    const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
    const bar = document.getElementById('status-bar');
    
    if (isStandalone) {
      bar.innerHTML = "âœ… APP MODE ACTIVE (NOTIFICATIONS ALLOWED)";
      bar.className = "bg-green-600 text-white p-3 text-center text-xs font-bold uppercase tracking-wider";
    }

    // --- 2. NOTIFICATION LOGIC ---
    async function tryNotify() {
      // Diagnostic Alert
      if (!isStandalone) {
        alert("âš ï¸ STOP: The top bar is RED.\n\n1. Delete the old icon.\n2. Tap Share -> Add to Home Screen.\n3. Open the NEW icon.");
        return; // Don't even try, it will fail.
      }

      try {
        const p = await Notification.requestPermission();
        if (p === 'granted') {
          alert("âœ… PERMISSION GRANTED!\n\nI will send a test notification in 5 seconds. \n\nDO NOT CLOSE THE APP.");
          setTimeout(() => {
            trigger("Test Success", "If you see this, you are done!");
          }, 5000);
        } else {
          alert("âŒ PERMISSION DENIED.\nGo to iPhone Settings -> Notifications -> Tracker -> Turn ON.");
        }
      } catch (e) {
        alert("Error: " + e.message);
      }
    }

    function trigger(title, body) {
      document.getElementById('notif-sound').play().catch(()=>{});
      if(navigator.vibrate) navigator.vibrate([500]);
      
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'SHOW_NOTIFICATION', title, body });
      } else {
        new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png' });
      }
    }

    // --- SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
      const swCode = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('message',e=>{if(e.data.type==='SHOW_NOTIFICATION')self.registration.showNotification(e.data.title,{body:e.data.body,icon:'https://cdn-icons-png.flaticon.com/512/3389/3389081.png'})});`;
      const blob = new Blob([swCode], {type: 'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    }

    // --- APP ---
    const SCHEDULE={1:['Math','Economy'],2:['Math','Essay','CS'],3:['Math'],4:['Economy'],5:['Essay','Math','CS']};
    const CLASSES=['Math','Economy','CS','Essay'];
    let counts={Math:0,Economy:0,CS:0,Essay:0}, todayAttended={}, editMode=null, editValue='';

    function loadData() {
      const s=localStorage.getItem('class-counts-v2'); if(s)counts=JSON.parse(s);
      const t=new Date().toDateString();
      if(localStorage.getItem('last-date')!==t) { todayAttended={}; localStorage.setItem('today-attended-v2',JSON.stringify({})); localStorage.setItem('last-date',t); }
      else { const st=localStorage.getItem('today-attended-v2'); if(st)todayAttended=JSON.parse(st); }
    }
    function saveData() { localStorage.setItem('class-counts-v2',JSON.stringify(counts)); localStorage.setItem('today-attended-v2',JSON.stringify(todayAttended)); }
    
    function markAttendance(c,a) {
      const p=todayAttended[c]; todayAttended[c]=a;
      if(a){ if(p!==true)counts[c]++; if(counts[c]===9)trigger('Î•Î™Î”ÎŸÎ ÎŸÎ™Î—Î£Î—',`Ï€Î»Î·ÏÏ‰ÏƒÎµ ${c}`); if(counts[c]>=10)counts[c]=0; }
      else{ if(p===true&&counts[c]>0)counts[c]--; }
      saveData(); render();
    }

    function startEdit(c) { editMode=c; editValue=counts[c]; render(); }
    function saveEdit() {
      const v=parseInt(editValue)||0; counts[editMode]=v;
      if(v===9)trigger('Î•Î™Î”ÎŸÎ ÎŸÎ™Î—Î£Î—',`Ï€Î»Î·ÏÏ‰ÏƒÎµ ${editMode}`); if(v>=10)counts[editMode]=0;
      editMode=null; saveData(); render();
    }
    
    function render() {
      const d=new Date().getDay(), tc=SCHEDULE[d]||[];
      document.getElementById('app').innerHTML=`
        <div class="max-w-md mx-auto px-4">
           <div class="bg-white p-4 rounded-xl shadow mb-4">
             <h2 class="font-bold mb-2">Today</h2>
             ${tc.map(c=>`<div class="flex justify-between mb-2 p-2 bg-slate-50 rounded"><span>${c}</span><div><button onclick="markAttendance('${c}',false)" class="px-2 border bg-white">Miss</button><button onclick="markAttendance('${c}',true)" class="px-2 border bg-white ml-2">Attend</button></div></div>`).join('')}
           </div>
           <div class="grid grid-cols-2 gap-2">
             ${CLASSES.map(c=>`<div class="bg-white p-3 rounded shadow text-center relative"><div class="flex justify-between text-xs absolute w-full px-2 left-0 top-1"><span>${c}</span><span onclick="startEdit('${c}')">âœŽ</span></div>${editMode===c?`<div class="mt-4"><input type="number" value="${editValue}" oninput="editValue=this.value" class="border w-12 text-center"><button onclick="saveEdit()" class="ml-1 bg-blue-500 text-white px-1">âœ“</button></div>`:`<div class="text-3xl font-bold mt-2">${counts[c]}/10</div>`}</div>`).join('')}
           </div>
        </div>`;
    }
    loadData(); render();
  </script>
</body>
</html>
