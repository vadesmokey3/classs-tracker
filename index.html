<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href='data:application/manifest+json,{"name":"Class Tracker","short_name":"Tracker","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#4F46E5","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3389/3389081.png","sizes":"192x192","type":"image/png"}]}' />
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 pb-20">

  <!-- TEST BUTTON -->
  <div class="bg-indigo-900 p-4 sticky top-0 z-50 shadow-xl text-center">
    <button onclick="start30sTest()" id="test-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl text-lg border-2 border-white shadow-lg animate-pulse">
      üîî TEST NOTIFICATION (30s)
    </button>
    <p class="text-indigo-200 text-xs mt-2">1. Press Button. 2. Press Home Button. 3. Wait.</p>
  </div>

  <div id="app"></div>
  
  <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

  <script>
    // --- 1. SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', (e) => self.skipWaiting());
        self.addEventListener('activate', (e) => self.clients.claim());
        
        self.addEventListener('message', (e) => {
          if (e.data && e.data.type === 'SHOW_NOTIFICATION') {
            self.registration.showNotification(e.data.title, {
              body: e.data.body,
              icon: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png',
              badge: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png',
              vibrate: [500, 250, 500, 250, 500],
              tag: 'payment-alert-' + Date.now(), 
              renotify: true,
              requireInteraction: true 
            });
          }
        });

        self.addEventListener('notificationclick', function(event) {
          event.notification.close();
          event.waitUntil(clients.openWindow(self.location.origin));
        });
      `;
      const blob = new Blob([swCode], {type: 'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    }

    // --- 2. NOTIFICATION TRIGGER ---
    function triggerPushNotification(title, body) {
      document.getElementById('notif-sound').play().catch(()=>{});
      if (navigator.vibrate) navigator.vibrate([500, 200, 500]);

      if (Notification.permission === 'granted') {
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION', title: title, body: body
          });
        } else {
          new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png' });
        }
      }
    }

    // --- 3. TEST LOGIC ---
    async function start30sTest() {
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') { alert("Allow notifications first!"); return; }
      try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e){}

      let timeLeft = 30;
      const btn = document.getElementById('test-btn');
      btn.classList.remove('animate-pulse', 'bg-red-600');
      btn.classList.add('bg-yellow-500');
      
      const interval = setInterval(() => {
        timeLeft--;
        btn.innerText = `‚è≥ MINIMIZE APP NOW (${timeLeft}s)`;
        if (timeLeft <= 0) {
          clearInterval(interval);
          btn.innerText = "üîî NOTIFICATION SENT!";
          btn.classList.add('bg-green-500');
          triggerPushNotification("ŒïŒôŒîŒüŒ†ŒüŒôŒóŒ£Œó Œ†ŒõŒóŒ°Œ©ŒúŒóŒ£", "œÄŒªŒ∑œÅœâœÉŒµ œÉœÑŒø ŒµœÄŒøŒºŒµŒΩŒø ŒºŒ±Œ∏Œ∑ŒºŒ± œÑŒ∑ŒΩ Math");
        }
      }, 1000);
    }

    // --- 4. APP LOGIC ---
    const SCHEDULE = {
      1: ['Math', 'Economy'], 2: ['Math', 'Essay', 'CS'], 3: ['Math'],
      4: ['Economy'], 5: ['Essay', 'Math', 'CS']
    };
    const CLASSES = ['Math', 'Economy', 'CS', 'Essay'];
    let counts = { Math: 0, Economy: 0, CS: 0, Essay: 0 };
    let todayAttended = {};
    let editMode = null;
    let editValue = '';

    function loadData() {
      const saved = localStorage.getItem('class-counts-v2');
      if (saved) counts = JSON.parse(saved);
      const today = new Date().toDateString();
      if (localStorage.getItem('last-date') !== today) {
        todayAttended = {};
        localStorage.setItem('today-attended-v2', JSON.stringify({}));
        localStorage.setItem('last-date', today);
      } else {
        const savedToday = localStorage.getItem('today-attended-v2');
        if (savedToday) todayAttended = JSON.parse(savedToday);
      }
    }

    function saveData() {
      localStorage.setItem('class-counts-v2', JSON.stringify(counts));
      localStorage.setItem('today-attended-v2', JSON.stringify(todayAttended));
    }

    function autoAttendClasses() {
      const dayOfWeek = new Date().getDay();
      const todayClasses = SCHEDULE[dayOfWeek] || [];
      let hasChanges = false;
      let notificationQueue = [];

      todayClasses.forEach(className => {
        if (todayAttended[className] === undefined) {
          todayAttended[className] = true;
          counts[className]++;
          hasChanges = true;

          // --- LOGIC CHANGE: NOTIFY AT 9 ---
          if (counts[className] === 9) {
            notificationQueue.push(`œÄŒªŒ∑œÅœâœÉŒµ œÉœÑŒø ŒµœÄŒøŒºŒµŒΩŒø ŒºŒ±Œ∏Œ∑ŒºŒ± œÑŒ∑ŒΩ ${className}`);
          }
          // Reset at 10 (Silent reset)
          if (counts[className] >= 10) {
            counts[className] = 0;
          }
        }
      });

      if (hasChanges) {
        saveData();
        render();
        if (notificationQueue.length > 0) {
          // Send notification for the first class that hit 9
          triggerPushNotification('‚ö†Ô∏è ŒïŒôŒîŒüŒ†ŒüŒôŒóŒ£Œó Œ†ŒõŒóŒ°Œ©ŒúŒóŒ£', notificationQueue[0]);
        }
      }
    }

    function markAttendance(className, isAttending) {
      const prev = todayAttended[className];
      todayAttended[className] = isAttending;

      if (isAttending) {
        // Only increment if we weren't already attending
        if (prev !== true) {
            counts[className]++;
        }

        // --- LOGIC CHANGE: NOTIFY AT 9 ---
        if (counts[className] === 9) {
            triggerPushNotification('‚ö†Ô∏è ŒïŒôŒîŒüŒ†ŒüŒôŒóŒ£Œó Œ†ŒõŒóŒ°Œ©ŒúŒóŒ£', `œÄŒªŒ∑œÅœâœÉŒµ œÉœÑŒø ŒµœÄŒøŒºŒµŒΩŒø ŒºŒ±Œ∏Œ∑ŒºŒ± œÑŒ∑ŒΩ ${className}`);
        }
        
        // Reset at 10
        if (counts[className] >= 10) {
            counts[className] = 0;
        }

      } else {
        // If unchecking "Attended", go down
        if (prev === true && counts[className] > 0) {
            counts[className]--;
        }
      }

      saveData();
      render();
    }

    function startEdit(className) { editMode = className; editValue = counts[className]; render(); }
    
    function saveEdit() {
      const newValue = parseInt(editValue) || 0;
      counts[editMode] = newValue;
      
      // If manual edit hits 9, notify
      if (newValue === 9) {
        triggerPushNotification('‚ö†Ô∏è ŒïŒôŒîŒüŒ†ŒüŒôŒóŒ£Œó Œ†ŒõŒóŒ°Œ©ŒúŒóŒ£', `œÄŒªŒ∑œÅœâœÉŒµ œÉœÑŒø ŒµœÄŒøŒºŒµŒΩŒø ŒºŒ±Œ∏Œ∑ŒºŒ± œÑŒ∑ŒΩ ${editMode}`);
      }
      // If manual edit hits 10+, reset
      if (newValue >= 10) {
        counts[editMode] = 0;
      }
      
      editMode = null; saveData(); render();
    }

    function render() {
      const dayOfWeek = new Date().getDay();
      const todayClasses = SCHEDULE[dayOfWeek] || [];
      
      document.getElementById('app').innerHTML = `
        <div class="max-w-md mx-auto mt-4 px-4">
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6">
            <h2 class="font-bold text-slate-700 mb-3">Today's Classes</h2>
            ${todayClasses.length ? todayClasses.map(cls => `
              <div class="flex items-center justify-between mb-3 p-2 bg-slate-50 rounded-lg">
                <span class="font-medium">${cls}</span>
                <div class="flex gap-2">
                  <button onclick="markAttendance('${cls}', false)" class="${todayAttended[cls]===false ? 'bg-red-500 text-white' : 'bg-white border'} px-3 py-1 rounded text-sm">Missed</button>
                  <button onclick="markAttendance('${cls}', true)" class="${todayAttended[cls]===true ? 'bg-green-500 text-white' : 'bg-white border'} px-3 py-1 rounded text-sm">Attended</button>
                </div>
              </div>
            `).join('') : '<p class="text-center text-slate-400">No classes</p>'}
          </div>

          <div class="grid grid-cols-2 gap-3">
            ${CLASSES.map(cls => `
              <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                <div class="flex justify-between mb-1">
                  <span class="text-sm text-slate-500">${cls}</span>
                  <button onclick="startEdit('${cls}')">‚úé</button>
                </div>
                ${editMode === cls ? `
                  <div class="flex gap-1">
                    <input type="number" value="${editValue}" oninput="editValue=this.value" class="w-full border rounded px-1">
                    <button onclick="saveEdit()" class="bg-indigo-500 text-white px-2 rounded">‚úì</button>
                  </div>
                ` : `
                  <div class="text-3xl font-bold ${counts[cls] === 9 ? 'text-red-600 animate-pulse' : 'text-slate-800'}">
                    ${counts[cls]}<span class="text-sm font-normal text-slate-400">/10</span>
                  </div>
                `}
                <div class="absolute bottom-0 left-0 h-1 bg-indigo-500 transition-all duration-500" style="width:${(counts[cls]/10)*100}%"></div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Init
    window.start30sTest = start30sTest;
    window.markAttendance = markAttendance;
    window.startEdit = startEdit;
    window.saveEdit = saveEdit;
    loadData();
    render();
    setTimeout(autoAttendClasses, 500);
  </script>
</body>
</html>
