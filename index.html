<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Class Tracker">
  <title>Class Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
  <link rel="manifest" href='data:application/manifest+json,{"name":"Class Tracker","short_name":"Tracker","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#4F46E5","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3389/3389081.png","sizes":"192x192","type":"image/png"}]}' />
  <style>
    body { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
    button { touch-action: manipulation; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 pb-20">

  <!-- iOS INSTRUCTION BANNER -->
  <div id="ios-guide" class="bg-slate-800 text-white p-4 text-center hidden">
    <p class="font-bold text-yellow-400 text-lg">âš ï¸ STOP!</p>
    <p class="mt-2">You are running this in a <strong>Browser Tab</strong>.</p>
    <p class="mt-2">Apple <strong>BLOCKS</strong> notifications here.</p>
    <div class="mt-4 bg-slate-700 p-3 rounded-lg text-left text-sm">
      <p>1. Tap the <strong>Share Button</strong> <span class="text-xl">â‹</span></p>
      <p>2. Scroll down & tap <strong>Add to Home Screen</strong></p>
      <p>3. Close Safari.</p>
      <p>4. Open the <strong>New Icon</strong> on your home screen.</p>
    </div>
  </div>

  <!-- TEST BUTTON -->
  <div class="bg-indigo-900 p-4 sticky top-0 z-50 shadow-xl text-center">
    <button onclick="handleTestClick()" id="test-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl text-lg border-2 border-white shadow-lg animate-pulse active:scale-95 transition-transform">
      ğŸ”” TEST PERMISSION
    </button>
  </div>

  <div id="app"></div>
  
  <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

  <script>
    // --- 1. DETECT IF IN APP MODE ---
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

    // Show guide if in Safari Tab
    if (isIOS && !isStandalone) {
      document.getElementById('ios-guide').classList.remove('hidden');
      document.getElementById('test-btn').innerText = "âš ï¸ READ INSTRUCTIONS ABOVE";
      document.getElementById('test-btn').classList.remove('bg-red-600', 'animate-pulse');
      document.getElementById('test-btn').classList.add('bg-slate-500');
    }

    // --- 2. CLICK HANDLER ---
    async function handleTestClick() {
      if (isIOS && !isStandalone) {
        alert("â›”ï¸ STOP! \n\nYou are in a Safari Tab. Apple BLOCKS notifications here.\n\nPlease tap Share -> 'Add to Home Screen' and open the app icon.");
        return;
      }

      // If we are here, we are likely in App Mode
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          start30sTest();
        } else {
          alert("âŒ PERMISSION DENIED\n\nYou might have clicked 'Don't Allow' before.\n\nGo to iPhone Settings -> Notifications -> Class Tracker -> Turn ON.");
        }
      } catch (e) {
        alert("Error: " + e.message);
      }
    }

    // --- 3. THE ACTUAL TEST ---
    function start30sTest() {
      // Play silent audio to keep app awake
      const audio = document.getElementById('notif-sound');
      if(audio) { audio.volume = 0.1; audio.play().catch(()=>{}); }

      let timeLeft = 5;
      const btn = document.getElementById('test-btn');
      btn.innerText = "â³ KEEP APP OPEN (5s)...";
      btn.className = "w-full bg-yellow-500 text-white font-bold py-3 rounded-xl shadow-lg";

      const interval = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
          clearInterval(interval);
          btn.innerText = "ğŸ”” SENT!";
          btn.className = "w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg";
          if(audio) audio.volume = 1.0;
          triggerPushNotification("Î•Î™Î”ÎŸÎ ÎŸÎ™Î—Î£Î—", "Test Successful! âœ…");
        } else {
          btn.innerText = `â³ WAIT ${timeLeft}s...`;
        }
      }, 1000);
    }

    // --- 4. NOTIFICATION LOGIC ---
    function triggerPushNotification(title, body) {
      try {
        const audio = document.getElementById('notif-sound');
        if (audio) { audio.currentTime = 0; audio.play().catch(()=>{}); }
        if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
        
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({ type: 'SHOW_NOTIFICATION', title, body });
        } else {
          new Notification(title, { body, icon: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png' });
        }
      } catch (e) {
        console.error(e);
      }
    }

    // --- SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', (e) => self.skipWaiting());
        self.addEventListener('activate', (e) => self.clients.claim());
        self.addEventListener('message', (e) => {
          if (e.data && e.data.type === 'SHOW_NOTIFICATION') {
            self.registration.showNotification(e.data.title, {
              body: e.data.body,
              icon: 'https://cdn-icons-png.flaticon.com/512/3389/3389081.png'
            });
          }
        });
      `;
      const blob = new Blob([swCode], {type: 'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob));
    }

    // --- APP LOGIC ---
    const SCHEDULE = { 1: ['Math', 'Economy'], 2: ['Math', 'Essay', 'CS'], 3: ['Math'], 4: ['Economy'], 5: ['Essay', 'Math', 'CS'] };
    const CLASSES = ['Math', 'Economy', 'CS', 'Essay'];
    let counts = { Math: 0, Economy: 0, CS: 0, Essay: 0 };
    let todayAttended = {};
    let editMode = null, editValue = '';

    function loadData() {
      const saved = localStorage.getItem('class-counts-v2');
      if (saved) counts = JSON.parse(saved);
      const today = new Date().toDateString();
      if (localStorage.getItem('last-date') !== today) {
        todayAttended = {};
        localStorage.setItem('today-attended-v2', JSON.stringify({}));
        localStorage.setItem('last-date', today);
      } else {
        const savedToday = localStorage.getItem('today-attended-v2');
        if (savedToday) todayAttended = JSON.parse(savedToday);
      }
    }

    function saveData() {
      localStorage.setItem('class-counts-v2', JSON.stringify(counts));
      localStorage.setItem('today-attended-v2', JSON.stringify(todayAttended));
    }

    function autoAttendClasses() {
      const dayOfWeek = new Date().getDay();
      const todayClasses = SCHEDULE[dayOfWeek] || [];
      let hasChanges = false;
      let notificationQueue = [];

      todayClasses.forEach(className => {
        if (todayAttended[className] === undefined) {
          todayAttended[className] = true;
          counts[className]++;
          hasChanges = true;
          if (counts[className] === 9) notificationQueue.push(`Ï€Î»Î·ÏÏ‰ÏƒÎµ ÏƒÏ„Î¿ ÎµÏ€Î¿Î¼ÎµÎ½Î¿ Î¼Î±Î¸Î·Î¼Î± Ï„Î·Î½ ${className}`);
          if (counts[className] >= 10) counts[className] = 0;
        }
      });

      if (hasChanges) {
        saveData();
        render();
        if (notificationQueue.length > 0) setTimeout(() => triggerPushNotification('âš ï¸ Î•Î™Î”ÎŸÎ ÎŸÎ™Î—Î£Î—', notificationQueue[0]), 100);
      }
    }

    function markAttendance(className, isAttending) {
      const prev = todayAttended[className];
      todayAttended[className] = isAttending;
      let shouldNotify = false;

      if (isAttending) {
        if (prev !== true) counts[className]++;
        if (counts[className] === 9) shouldNotify = true;
        if (counts[className] >= 10) counts[className] = 0;
      } else {
        if (prev === true && counts[className] > 0) counts[className]--;
      }
      saveData(); render();
      if (shouldNotify) setTimeout(() => triggerPushNotification('âš ï¸ Î•Î™Î”ÎŸÎ ÎŸÎ™Î—Î£Î—', `Ï€Î»Î·ÏÏ‰ÏƒÎµ ÏƒÏ„Î¿ ÎµÏ€Î¿Î¼ÎµÎ½Î¿ Î¼Î±Î¸Î·Î¼Î± Ï„Î·Î½ ${className}`), 50);
    }

    function startEdit(className) { editMode = className; editValue = counts[className]; render(); }
    function saveEdit() {
      const val = parseInt(editValue) || 0;
      counts[editMode] = val;
      let shouldNotify = (val === 9);
      if (val >= 10) counts[editMode] = 0;
      editMode = null; saveData(); render();
      if (shouldNotify) setTimeout(() => triggerPushNotification('âš ï¸ Î•Î™Î”ÎŸÎ ÎŸÎ™Î—Î£Î—', `Ï€Î»Î·ÏÏ‰ÏƒÎµ ÏƒÏ„Î¿ ÎµÏ€Î¿Î¼ÎµÎ½Î¿ Î¼Î±Î¸Î·Î¼Î± Ï„Î·Î½ ${val === 9 ? counts[editMode] : 'Class'}`), 50);
    }

    function render() {
      const dayOfWeek = new Date().getDay();
      const todayClasses = SCHEDULE[dayOfWeek] || [];
      document.getElementById('app').innerHTML = `
        <div class="max-w-md mx-auto mt-4 px-4">
          <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6">
            <h2 class="font-bold text-slate-700 mb-3">Today's Classes</h2>
            ${todayClasses.length ? todayClasses.map(cls => `
              <div class="flex flex-col mb-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                <div class="flex justify-between items-center mb-2">
                  <span class="font-bold text-lg">${cls}</span>
                  ${todayAttended[cls] === true ? '<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">âœ“ Auto-counted</span>' : ''}
                </div>
                <div class="flex gap-2">
                  <button onclick="markAttendance('${cls}', false)" class="flex-1 py-3 rounded-lg text-sm font-semibold shadow-sm transition active:scale-95 ${todayAttended[cls]===false ? 'bg-red-500 text-white' : 'bg-white border text-slate-600'}">Missed</button>
                  <button onclick="markAttendance('${cls}', true)" class="flex-1 py-3 rounded-lg text-sm font-semibold shadow-sm transition active:scale-95 ${todayAttended[cls]===true ? 'bg-green-500 text-white' : 'bg-white border text-slate-600'}">Attended</button>
                </div>
              </div>
            `).join('') : '<p class="text-center text-slate-400">No classes today</p>'}
          </div>

          <div class="grid grid-cols-2 gap-3">
            ${CLASSES.map(cls => `
              <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                <div class="flex justify-between mb-1">
                  <span class="text-sm text-slate-500">${cls}</span>
                  <button onclick="startEdit('${cls}')" class="p-2 -m-2 text-slate-400">âœ</button>
                </div>
                ${editMode === cls ? `
                  <div class="flex gap-1">
                    <input type="number" value="${editValue}" oninput="editValue=this.value" class="w-full border rounded px-1">
                    <button onclick="saveEdit()" class="bg-indigo-500 text-white px-2 rounded">âœ“</button>
                  </div>
                ` : `
                  <div class="text-3xl font-bold ${counts[cls] === 9 ? 'text-red-600 animate-pulse' : 'text-slate-800'}">
                    ${counts[cls]}<span class="text-sm font-normal text-slate-400">/10</span>
                  </div>
                `}
                <div class="absolute bottom-0 left-0 h-1 bg-indigo-500 transition-all duration-500" style="width:${(counts[cls]/10)*100}%" ></div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    loadData();
    render();
    setTimeout(autoAttendClasses, 200);
  </script>
</body>
</html>
